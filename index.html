<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lopburi Solar AR: Training Module</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom Animations */
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        @keyframes flow {
            0% { stroke-dashoffset: 24; }
            100% { stroke-dashoffset: 0; }
        }
        @keyframes bounce-in {
            0% { opacity: 0; transform: scale(0.3) translateY(-20px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes slide-up {
            0% { transform: translateY(100%); }
            100% { transform: translateY(0); }
        }
        @keyframes fade-in-down {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .animate-scan { animation: scan 3s linear infinite; }
        .animate-flow { animation: flow 1s linear infinite; }
        .animate-bounce-in { animation: bounce-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) both; }
        .animate-slide-up { animation: slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1) both; }
        .animate-fade-in-down { animation: fade-in-down 0.3s ease-out both; }
        .animate-ping-slow { animation: ping 2s cubic-bezier(0, 0, 0.2, 1) infinite; }
        .animate-spin-slow { animation: spin 3s linear infinite; }

        /* Disable scroll on mobile */
        body { touch-action: none; overscroll-behavior: none; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Icons (SVG Components) ---
        const Icon = ({ path, size = 24, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {path}
            </svg>
        );

        const Icons = {
            Camera: (props) => <Icon path={<><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>} {...props} />,
            Zap: (props) => <Icon path={<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>} {...props} />,
            AlertTriangle: (props) => <Icon path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></>} {...props} />,
            CheckCircle: (props) => <Icon path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} {...props} />,
            Info: (props) => <Icon path={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>} {...props} />,
            Activity: (props) => <Icon path={<polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />} {...props} />,
            BatteryCharging: (props) => <Icon path={<><path d="M5 18H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h3.19M15 6h2a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-3.19"/><line x1="23" y1="13" x2="23" y2="11"/><polyline points="11 6 7 12 13 12 9 18"/></>} {...props} />,
            ShieldAlert: (props) => <Icon path={<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>} {...props} />,
            X: (props) => <Icon path={<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>} {...props} />,
            Video: (props) => <Icon path={<><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></>} {...props} />,
            VideoOff: (props) => <Icon path={<><path d="M16 16v1a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2m5.66 0H14a2 2 0 0 1 2 2v3.34l1 1L23 7v10"/><line x1="1" y1="1" x2="23" y2="23"/></>} {...props} />,
            Settings: (props) => <Icon path={<><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>} {...props} />,
            BookOpen: (props) => <Icon path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} {...props} />
        };

        // --- Custom Hook for Camera ---
        const useCameraStream = (isActive) => {
            const videoRef = useRef(null);
            const [stream, setStream] = useState(null);
            const [error, setError] = useState(null);
            const [isLoading, setIsLoading] = useState(false);

            useEffect(() => {
                if (!isActive) {
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                        setStream(null);
                    }
                    return;
                }

                const startCamera = async () => {
                    setIsLoading(true);
                    setError(null);
                    try {
                        const constraints = {
                            video: {
                                facingMode: 'environment', // Prefer rear camera
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            }
                        };
                        const mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                        setStream(mediaStream);
                        if (videoRef.current) {
                            videoRef.current.srcObject = mediaStream;
                        }
                    } catch (err) {
                        console.error("Camera Access Error:", err);
                        setError("ไม่สามารถเข้าถึงกล้องได้ (กรุณาตรวจสอบการอนุญาต)");
                    } finally {
                        setIsLoading(false);
                    }
                };

                startCamera();

                return () => {
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                };
            }, [isActive]);

            return { videoRef, error, isLoading, hasStream: !!stream };
        };

        // --- Main App Component ---
        const App = () => {
            const [currentView, setCurrentView] = useState('home'); 
            const [notification, setNotification] = useState(null);
            const [useRealCamera, setUseRealCamera] = useState(true);

            const showNotification = useCallback((message, type = 'info') => {
                setNotification({ message, type });
                setTimeout(() => setNotification(null), 3500);
            }, []);

            const renderView = () => {
                switch (currentView) {
                    case 'home':
                        return <HomeView setView={setCurrentView} toggleCamera={setUseRealCamera} useCamera={useRealCamera} />;
                    case 'job-sheet-1':
                        return <JobSheet1View onBack={() => setCurrentView('home')} showNotification={showNotification} useCamera={useRealCamera} />;
                    case 'job-sheet-4':
                        return <JobSheet4View onBack={() => setCurrentView('home')} showNotification={showNotification} useCamera={useRealCamera} />;
                    case 'job-sheet-6':
                        return <JobSheet6View onBack={() => setCurrentView('home')} showNotification={showNotification} useCamera={useRealCamera} />;
                    default:
                        return <HomeView setView={setCurrentView} />;
                }
            };

            return (
                <div className="w-full h-screen bg-gray-900 text-white flex flex-col items-center justify-center">
                    <div className="w-full max-w-md h-full max-h-[900px] bg-black relative shadow-2xl overflow-hidden flex flex-col">
                        {/* Top Status Bar */}
                        <div className="absolute top-0 w-full p-2 px-4 flex justify-between items-center z-50 bg-gradient-to-b from-black/90 to-transparent pointer-events-none">
                            <span className="text-xs text-gray-300 font-mono tracking-wider">Lopburi Solar Training</span>
                            <div className="flex gap-2 text-xs items-center">
                                <span className={`w-2 h-2 rounded-full ${useRealCamera ? 'bg-green-500' : 'bg-yellow-500'} animate-pulse`}></span>
                                <Icons.BatteryCharging size={16} />
                                <span>100%</span>
                            </div>
                        </div>

                        {/* Main Content Area */}
                        <div className="flex-1 relative w-full h-full">
                            {renderView()}
                        </div>

                        {/* Global Notification Toast */}
                        {notification && (
                            <div className={`absolute top-20 left-4 right-4 p-4 rounded-xl shadow-2xl flex items-center gap-3 animate-bounce-in z-[60] border border-white/10 backdrop-blur-md ${
                                notification.type === 'danger' ? 'bg-red-600/90 text-white' : 
                                notification.type === 'success' ? 'bg-green-600/90 text-white' : 'bg-blue-600/90 text-white'
                            }`}>
                                <div className="p-2 bg-white/20 rounded-full">
                                    {notification.type === 'danger' ? <Icons.ShieldAlert size={20} /> : notification.type === 'success' ? <Icons.CheckCircle size={20} /> : <Icons.Info size={20} />}
                                </div>
                                <p className="text-sm font-medium pr-2">{notification.message}</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- View Components ---

        const HomeView = ({ setView, toggleCamera, useCamera }) => (
            <div className="flex flex-col h-full bg-slate-900 p-6 pt-20 relative overflow-hidden">
                <div className="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-blue-900/50 to-transparent pointer-events-none" />
                
                <div className="relative z-10 mb-8 text-center">
                    <div className="w-24 h-24 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-3xl mx-auto flex items-center justify-center mb-6 shadow-2xl shadow-yellow-500/30 transform hover:scale-105 transition-transform duration-300">
                        <Icons.BookOpen size={48} className="text-white drop-shadow-md" />
                    </div>
                    <h1 className="text-3xl font-bold text-white mb-2 tracking-tight">AR Training</h1>
                    <p className="text-gray-400 text-sm font-light">หลักสูตรติดตั้งโซลาร์เซลล์</p>
                    <div className="inline-block px-3 py-1 bg-yellow-500/10 border border-yellow-500/30 rounded-full mt-3">
                        <p className="text-yellow-500 text-xs font-semibold">สนพ.ลพบุรี</p>
                    </div>
                </div>

                <div className="relative z-10 space-y-4 flex-1">
                    <MenuCard 
                        title="ใบงานที่ 1: ทดสอบแผง" 
                        desc="วัดค่า Voc และ Isc (Model LR5-72HGD)"
                        icon={<Icons.Activity className="text-orange-400" />}
                        color="orange"
                        onClick={() => setView('job-sheet-1')}
                    />
                    <MenuCard 
                        title="ใบงานที่ 4: ประกอบตู้ Protection" 
                        desc="เรียนรู้อุปกรณ์ Fuse, Surge, RCBO"
                        icon={<Icons.ShieldAlert className="text-blue-400" />}
                        color="blue"
                        onClick={() => setView('job-sheet-4')}
                    />
                    <MenuCard 
                        title="ใบงานที่ 6: เข้าสาย On-grid" 
                        desc="จำลองการเดินสาย Inverter เข้าระบบ"
                        icon={<Icons.Zap className="text-green-400" />}
                        color="green"
                        onClick={() => setView('job-sheet-6')}
                    />
                </div>

                <div className="relative z-10 mt-6 pt-6 border-t border-gray-800">
                    <div className="flex justify-between items-center text-gray-500 text-xs">
                        <button 
                            onClick={() => toggleCamera(!useCamera)}
                            className="flex items-center gap-2 px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors"
                        >
                            {useCamera ? <Icons.Video size={14} className="text-green-500"/> : <Icons.VideoOff size={14} className="text-red-500"/>}
                            <span>{useCamera ? 'Camera: ON' : 'Camera: Simulation'}</span>
                        </button>
                        <div className="flex items-center gap-2">
                            <Icons.Settings size={14} />
                            <span>v2.0 Doc-Aligned</span>
                        </div>
                    </div>
                </div>
            </div>
        );

        // --- ใบงานที่ 1: Test Solar Cell ---
        const JobSheet1View = ({ onBack, showNotification, useCamera }) => {
            const [mode, setMode] = useState('Voc'); // Voc or Isc
            const [value, setValue] = useState(0);

            // Tech Specs from PDF Page 5: LONGi LR5-72HGD-585M
            // Voc = 51.52 V
            // Isc = 14.30 A
            
            useEffect(() => {
                const interval = setInterval(() => {
                    const baseVal = mode === 'Voc' ? 51.52 : 14.30;
                    // Add slight fluctuation to simulate real measurement
                    const noise = (Math.random() * 0.2) - 0.1; 
                    setValue(baseVal + noise);
                }, 500);
                return () => clearInterval(interval);
            }, [mode]);

            return (
                <AROverlay title="ใบงานที่ 1: ทดสอบค่าไฟฟ้า" onBack={onBack} useCamera={useCamera}>
                    <div className="relative w-full h-full flex flex-col items-center justify-center">
                        {/* Virtual Multimeter Interface */}
                        <div className="absolute top-20 bg-black/80 p-4 rounded-xl border-2 border-yellow-500 shadow-2xl w-64 text-center">
                            <div className="text-gray-400 text-xs mb-1 font-mono">DIGITAL MULTIMETER</div>
                            <div className="bg-[#9ea792] font-mono text-3xl text-black py-2 px-4 rounded mb-4 shadow-inner">
                                {value.toFixed(2)} <span className="text-sm">{mode === 'Voc' ? 'V' : 'A'}</span>
                            </div>
                            
                            <div className="flex gap-2 justify-center">
                                <button 
                                    onClick={() => { setMode('Voc'); showNotification("วัดแรงดันไฟฟ้าเปิดวงจร (Voc)"); }}
                                    className={`px-4 py-2 rounded font-bold text-sm ${mode === 'Voc' ? 'bg-yellow-500 text-black' : 'bg-gray-700 text-white'}`}
                                >
                                    Voc
                                </button>
                                <button 
                                    onClick={() => { setMode('Isc'); showNotification("วัดกระแสไฟฟ้าลัดวงจร (Isc)"); }}
                                    className={`px-4 py-2 rounded font-bold text-sm ${mode === 'Isc' ? 'bg-yellow-500 text-black' : 'bg-gray-700 text-white'}`}
                                >
                                    Isc
                                </button>
                            </div>
                        </div>

                        {/* AR Probe Guides */}
                        <div className="absolute inset-0 pointer-events-none">
                            <div className="absolute top-1/2 left-1/4 w-32 h-1 bg-red-500 transform rotate-45 shadow-lg"></div>
                            <div className="absolute top-1/2 left-1/4 -mt-2 -ml-2 bg-red-600 w-4 h-4 rounded-full"></div>
                            <div className="absolute top-1/2 left-1/4 mt-4 ml-4 bg-black/50 text-white text-xs px-2 rounded">ขั้วบวก (+)</div>

                            <div className="absolute top-1/2 right-1/4 w-32 h-1 bg-black transform -rotate-45 shadow-lg"></div>
                            <div className="absolute top-1/2 right-1/4 -mt-2 -mr-2 bg-gray-800 w-4 h-4 rounded-full"></div>
                            <div className="absolute top-1/2 right-1/4 mt-4 mr-4 bg-black/50 text-white text-xs px-2 rounded">ขั้วลบ (-)</div>
                        </div>

                        <div className="absolute bottom-10 bg-white/10 backdrop-blur-md p-4 rounded-lg max-w-xs text-sm text-center">
                            <p className="font-bold text-yellow-400 mb-1">สเปกแผง (Datasheet)</p>
                            <p>Model: LR5-72HGD-585M</p>
                            <p>STC: 1000W/m², 25°C</p>
                        </div>
                    </div>
                </AROverlay>
            );
        };

        // --- ใบงานที่ 4: Protection Cabinet ---
        const JobSheet4View = ({ onBack, showNotification, useCamera }) => {
            const [selectedPart, setSelectedPart] = useState(null);

            // Components from PDF Page 15-16
            const parts = [
                { id: 1, name: 'DC Fuse', code: 'WSPV-30', spec: '1000V DC 30A', x: '20%', y: '40%', type: 'dc' },
                { id: 2, name: 'DC Surge', code: 'XLSPD-PV', spec: '1200V DC 20-40kA', x: '40%', y: '40%', type: 'dc' },
                { id: 3, name: 'AC Breaker', code: 'RCBO/MCB', spec: '230V AC C20', x: '65%', y: '40%', type: 'ac' },
                { id: 4, name: 'AC Surge', code: 'XLSPD-40', spec: '385V AC 20-40kA', x: '85%', y: '40%', type: 'ac' },
            ];

            return (
                <AROverlay title="ใบงานที่ 4: ตู้ Protection" onBack={onBack} useCamera={useCamera}>
                    <div className="relative w-full h-full">
                        {/* Virtual Cabinet Box */}
                        <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-80 h-64 border-4 border-gray-400 bg-gray-800/80 rounded-lg backdrop-blur-sm shadow-2xl">
                            <div className="absolute top-0 left-0 w-full bg-gray-700 h-8 flex items-center px-4 text-xs font-bold text-gray-300">
                                COMBINER BOX (IP65)
                            </div>
                            
                            {/* Rail */}
                            <div className="absolute top-1/2 left-4 right-4 h-4 bg-gray-400 rounded transform -translate-y-1/2"></div>

                            {/* Components */}
                            {parts.map(part => (
                                <button
                                    key={part.id}
                                    style={{ left: part.x, top: '50%' }}
                                    className={`absolute w-12 h-20 -ml-6 -mt-10 border rounded shadow-md transform transition-transform hover:scale-110 active:scale-95 flex flex-col items-center justify-center gap-1 ${
                                        part.type === 'dc' ? 'bg-red-900/80 border-red-500' : 'bg-blue-900/80 border-blue-500'
                                    }`}
                                    onClick={() => setSelectedPart(part)}
                                >
                                    <div className="text-[8px] font-bold text-white/80">{part.name}</div>
                                    <div className={`w-2 h-2 rounded-full ${part.type === 'dc' ? 'bg-red-500' : 'bg-blue-500'}`}></div>
                                </button>
                            ))}
                        </div>

                        {/* Connection Lines Hint */}
                        <div className="absolute top-[65%] left-1/2 transform -translate-x-1/2 text-xs text-gray-400 animate-pulse">
                            แตะที่อุปกรณ์เพื่อดูรายละเอียด
                        </div>

                        {selectedPart && (
                            <div className="absolute top-24 left-4 right-4 bg-white/10 backdrop-blur-xl border border-white/20 p-4 rounded-2xl animate-fade-in-down z-50 text-white">
                                <div className="flex justify-between items-start mb-2">
                                    <h3 className="font-bold text-lg text-yellow-400">{selectedPart.name}</h3>
                                    <button onClick={() => setSelectedPart(null)} className="p-1 hover:bg-white/10 rounded-full"><Icons.X size={18}/></button>
                                </div>
                                <div className="space-y-1 text-sm">
                                    <p><span className="text-gray-400">Model:</span> {selectedPart.code}</p>
                                    <p><span className="text-gray-400">Spec:</span> {selectedPart.spec}</p>
                                    <p className="text-xs text-gray-300 mt-2">
                                        {selectedPart.type === 'dc' ? 'ติดตั้งฝั่งรับไฟจากแผง Solar (IEC 60269-6)' : 'ติดตั้งฝั่งจ่ายไฟเข้า Grid (IEC 61643-11)'}
                                    </p>
                                </div>
                            </div>
                        )}
                    </div>
                </AROverlay>
            );
        };

        // --- ใบงานที่ 6: Wiring System ---
        const JobSheet6View = ({ onBack, showNotification, useCamera }) => {
            const [step, setStep] = useState(0);

            // Wiring Steps based on PDF Page 54-56
            const steps = [
                { id: 0, text: "แตะเพื่อเริ่มเดินสาย", highlight: [] },
                { id: 1, text: "1. เดินสาย DC (4 sq.mm) จากแผงเข้าตู้ Protection", highlight: ['panel', 'box'] },
                { id: 2, text: "2. เชื่อมต่อ DC จากตู้เข้า Inverter", highlight: ['box', 'inv'] },
                { id: 3, text: "3. เดินสาย AC (3x2.5 sq.mm) จาก Inverter กลับมาที่ตู้", highlight: ['inv', 'box'] },
                { id: 4, text: "4. เดินสาย AC ออกจากตู้ไปยัง Grid (PEA)", highlight: ['box', 'grid'] },
                { id: 5, text: "ระบบสมบูรณ์ พร้อมขนานไฟ", highlight: ['all'] }
            ];

            const nextStep = () => {
                if (step < 5) setStep(step + 1);
                else {
                    setStep(0);
                    showNotification("รีเซ็ตการจำลอง");
                }
            };

            return (
                <AROverlay title="ใบงานที่ 6: เข้าสาย On-grid" onBack={onBack} useCamera={useCamera}>
                    <div className="relative w-full h-full flex items-center justify-center" onClick={nextStep}>
                        
                        {/* Diagram Container */}
                        <div className="relative w-full h-full max-w-sm mx-auto mt-20 p-4">
                            
                            {/* Devices */}
                            <div className="absolute top-10 left-10 w-20 h-24 bg-blue-900 border-2 border-blue-400 rounded flex items-center justify-center text-xs font-bold shadow-lg z-10">
                                PV Panel
                            </div>
                            
                            <div className="absolute top-40 left-1/2 transform -translate-x-1/2 w-32 h-24 bg-gray-800 border-2 border-gray-500 rounded flex items-center justify-center text-xs font-bold shadow-lg z-10">
                                Protection Box
                            </div>

                            <div className="absolute top-10 right-10 w-20 h-24 bg-yellow-600 border-2 border-yellow-400 rounded flex items-center justify-center text-xs font-bold shadow-lg z-10">
                                Inverter
                            </div>

                            <div className="absolute bottom-20 left-1/2 transform -translate-x-1/2 w-24 h-16 bg-purple-900 border-2 border-purple-400 rounded-full flex items-center justify-center text-xs font-bold shadow-lg z-10">
                                Grid (PEA)
                            </div>

                            {/* Wiring SVG Overlay */}
                            <svg className="absolute inset-0 w-full h-full pointer-events-none z-0">
                                {/* Step 1: Panel -> Box */}
                                {step >= 1 && (
                                    <path d="M 70 80 L 70 140 L 140 160" fill="none" stroke="#ef4444" strokeWidth="3" strokeDasharray="5" className="animate-flow" />
                                )}
                                {/* Step 2: Box -> Inv */}
                                {step >= 2 && (
                                    <path d="M 210 160 L 280 140 L 280 80" fill="none" stroke="#ef4444" strokeWidth="3" strokeDasharray="5" className="animate-flow" />
                                )}
                                {/* Step 3: Inv -> Box (AC) */}
                                {step >= 3 && (
                                    <path d="M 260 80 L 260 130 L 200 150" fill="none" stroke="#22c55e" strokeWidth="3" strokeDasharray="5" className="animate-flow" />
                                )}
                                {/* Step 4: Box -> Grid */}
                                {step >= 4 && (
                                    <path d="M 180 200 L 180 250" fill="none" stroke="#22c55e" strokeWidth="3" strokeDasharray="5" className="animate-flow" />
                                )}
                            </svg>

                        </div>

                        {/* Instruction HUD */}
                        <div className="absolute bottom-12 left-4 right-4 bg-black/70 backdrop-blur-md border border-gray-600 p-4 rounded-xl">
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-yellow-400 font-bold text-sm">ขั้นตอนที่ {step}/5</span>
                                <span className="text-gray-400 text-xs">แตะหน้าจอเพื่อไปต่อ</span>
                            </div>
                            <p className="text-sm">{steps[step].text}</p>
                            {/* Progress Bar */}
                            <div className="w-full bg-gray-700 h-1 mt-3 rounded-full overflow-hidden">
                                <div className="bg-green-500 h-full transition-all duration-300" style={{ width: `${(step/5)*100}%` }}></div>
                            </div>
                        </div>

                    </div>
                </AROverlay>
            );
        };

        // --- Core Shared Components ---

        const AROverlay = ({ title, onBack, useCamera, children }) => {
            const { videoRef, error, isLoading } = useCameraStream(useCamera);

            return (
                <div className="relative w-full h-full bg-gray-900 overflow-hidden">
                    {useCamera ? (
                        <div className="absolute inset-0 bg-black">
                            {isLoading && (
                                <div className="absolute inset-0 flex items-center justify-center z-10 bg-gray-900">
                                    <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-yellow-500"></div>
                                </div>
                            )}
                            <video 
                                ref={videoRef}
                                autoPlay 
                                playsInline 
                                muted 
                                className="w-full h-full object-cover opacity-90"
                            />
                            {error && (
                                <div className="absolute inset-0 flex flex-col items-center justify-center bg-gray-900/90 z-20 p-6 text-center">
                                    <Icons.VideoOff size={48} className="text-red-500 mb-4" />
                                    <p className="text-white mb-2">{error}</p>
                                    <p className="text-gray-400 text-sm">ระบบจะเปลี่ยนไปใช้โหมดจำลองอัตโนมัติ</p>
                                </div>
                            )}
                        </div>
                    ) : (
                        <div className="absolute inset-0 bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center">
                           <div className="absolute inset-0 opacity-20" style={{backgroundImage: 'radial-gradient(circle at 2px 2px, white 1px, transparent 0)', backgroundSize: '40px 40px'}}></div>
                           <p className="text-gray-600 font-mono text-sm">[ Simulation Mode Active ]</p>
                        </div>
                    )}

                    <div className="absolute inset-0 z-30">
                        {children}
                    </div>

                    <div className="absolute top-0 w-full pt-12 pb-4 px-4 bg-gradient-to-b from-black/80 via-black/40 to-transparent flex items-center gap-4 z-40 pointer-events-none">
                        <button 
                            onClick={onBack}
                            className="pointer-events-auto p-2 rounded-full bg-white/10 backdrop-blur-md border border-white/20 hover:bg-white/20 transition-all text-white"
                        >
                            <Icons.X size={20} />
                        </button>
                        <div className="flex-1">
                            <h2 className="text-lg font-bold text-white tracking-wide shadow-black drop-shadow-md">{title}</h2>
                        </div>
                        {useCamera && !error && (
                            <div className="flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-red-500/80 backdrop-blur-md border border-red-400/30">
                                <div className="w-1.5 h-1.5 rounded-full bg-white animate-pulse" />
                                <span className="text-[10px] font-bold text-white tracking-wider">LIVE</span>
                            </div>
                        )}
                    </div>

                    <div className="absolute top-1/2 left-1/2 w-6 h-6 border border-white/40 rounded-full transform -translate-x-1/2 -translate-y-1/2 pointer-events-none z-30 flex items-center justify-center mix-blend-difference">
                        <div className="w-1 h-1 bg-white rounded-full"></div>
                    </div>
                </div>
            );
        };

        const MenuCard = ({ title, desc, icon, color, onClick }) => {
            const bgColors = {
                orange: 'bg-orange-500/10 border-orange-500/30 hover:bg-orange-500/20',
                blue: 'bg-blue-500/10 border-blue-500/30 hover:bg-blue-500/20',
                green: 'bg-green-500/10 border-green-500/30 hover:bg-green-500/20',
            };

            return (
                <button 
                    onClick={onClick}
                    className={`w-full p-4 rounded-2xl border backdrop-blur-sm flex items-center gap-4 transition-all active:scale-95 text-left group ${bgColors[color] || 'bg-gray-800'}`}
                >
                    <div className={`p-3 rounded-xl bg-gray-900 group-hover:scale-110 transition-transform duration-300 border border-gray-700 shadow-inner`}>
                        {icon}
                    </div>
                    <div className="flex-1">
                        <h3 className="font-bold text-white text-base mb-0.5">{title}</h3>
                        <p className="text-xs text-gray-400 font-light leading-relaxed">{desc}</p>
                    </div>
                </button>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>